##
# @file analysis.py
# @author Roman Moroz
# @brief –ú–æ–¥—É–ª—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–º–∞–Ω–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram.
# @details –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –ª–æ–≥–∏–∫—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –ø—Ä—è–º—ã–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Å
#          –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –û–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ –±–æ—Ç —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É `/start`,
#          –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–∞ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.
#          –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã - –ø—Ä–∏–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å, –ø—Ä–æ–≤–µ—Å—Ç–∏ –±–∞–∑–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é
#          –∏ –ø–µ—Ä–µ–¥–∞—Ç—å "—Ç—è–∂–µ–ª—É—é" —Ä–∞–±–æ—Ç—É –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ç–µ–∫—Å—Ç–∞ –≤ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –º–æ–¥—É–ª—å `analyzer`.

import logging

from aiogram import Router, F, types
from aiogram.filters import CommandStart

from services.analyzer import analyzer

logger = logging.getLogger("call_assessment_bot")

##
# @var analysis_router
# @brief –≠–∫–∑–µ–º–ø–ª—è—Ä `aiogram.Router` –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è.
# @details –≠—Ç–æ—Ç —Ä–æ—É—Ç–µ—Ä —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (—Ö–µ–Ω–¥–ª–µ—Ä—ã), –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ.
#          –ó–∞—Ç–µ–º –æ–Ω –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –≥–ª–∞–≤–Ω–æ–º—É –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É –≤ `main.py`,
#          —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å –∏ —á–∏—Å—Ç–æ—Ç—É –∫–æ–¥–∞.
analysis_router = Router()


@analysis_router.message(CommandStart())
async def cmd_start(message: types.Message):
    """!
    @brief –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã `/start`.
    @details
    –≠—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ø–µ—Ä–≤—ã–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞ –∏–ª–∏
    –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/start`. –û–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ,
    –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç —Å–≤–æ—é –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.
    @param message [in] –û–±—ä–µ–∫—Ç `aiogram.types.Message`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.
    """

    welcome_text = (
        f"üëã **–ü—Ä–∏–≤–µ—Ç, {message.from_user.full_name}!**\n\n"
        "–Ø ‚Äî –ò–ò-–∞–≥–µ–Ω—Ç –ø–æ –æ—Ü–µ–Ω–∫–µ –∑–≤–æ–Ω–∫–æ–≤. "
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞, "
        "–∏ —è –æ–ø—Ä–µ–¥–µ–ª—é –µ–≥–æ —Ç–æ–Ω –∏ –¥–∞–º –¥–≤–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é."
    )
    await message.answer(welcome_text, parse_mode="Markdown")


@analysis_router.message(F.text)
async def handle_text_message(message: types.Message):
    """!
    @brief –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—á–∏–π —Ö–µ–Ω–¥–ª–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
    @details
    –≠—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞ –ª—é–±–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–ª–∞–≥–æ–¥–∞—Ä—è —Ñ–∏–ª—å—Ç—Ä—É `F.text`.
    –õ–æ–≥–∏–∫–∞ –µ–≥–æ —Ä–∞–±–æ—Ç—ã —Å–ª–µ–¥—É—é—â–∞—è:
    1.  <b>–í–∞–ª–∏–¥–∞—Ü–∏—è:</b> –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω–∏–º—É–º 10 —Å–ª–æ–≤).
        –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞, –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
    2.  <b>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:</b> –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...",
        —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É. –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç.
    3.  <b>–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:</b> –í—ã–∑—ã–≤–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `analyze_call` –∏–∑ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ
        —Å–µ—Ä–≤–∏—Å–∞ `analyzer`, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–º—É —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –í—Å—è —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
        –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–º.
    4.  <b>–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:</b> –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Ç `analyzer`, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç
        —Ä–∞–Ω–µ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...", –∑–∞–º–µ–Ω—è—è –µ–≥–æ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç.
        –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å "–∑–∞—Å–æ—Ä–µ–Ω–∏—è" —á–∞—Ç–∞ –ª–∏—à–Ω–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
    5.  <b>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∫ –¥–µ–π—Å—Ç–≤–∏—é:</b> –°–æ–æ–±—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –≥–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–¥–∞–Ω–∏—é.
    @param message [in] –û–±—ä–µ–∫—Ç `aiogram.types.Message` —Å —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
    """

    if not message.text or len(message.text.split()) < 10:
        await message.answer(
            "‚ö†Ô∏è –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –î–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10 —Å–ª–æ–≤."
        )
        return

    processing_msg = await message.answer(
        "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∏–∞–ª–æ–≥... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥."
    )
    logger.info(
        f"Started analysis for user {message.from_user.id}. Text length: {len(message.text)}"
    )

    analysis_result = await analyzer.analyze_call(message.text)

    await processing_msg.edit_text(analysis_result, parse_mode="Markdown")

    logger.info(f"Finished analysis for user {message.from_user.id}")
    await message.answer("–ì–æ—Ç–æ–≤ –∫ –∞–Ω–∞–ª–∏–∑—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞!")


@analysis_router.message(F.content_type.is_not(types.ContentType.TEXT))
async def handle_unsupported_message(message: types.Message):
    """!
    @brief –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π.
    @details
    –≠—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "–º–∞–≥–∏—á–µ—Å–∫–∏–π" —Ñ–∏–ª—å—Ç—Ä `F.content_type.is_not(...)` –¥–ª—è
    –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —è–≤–ª—è—é—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ, —Å—Ç–∏–∫–µ—Ä—ã,
    –∞—É–¥–∏–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ç.–¥.). –û–Ω –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Ç–æ–º, —á—Ç–æ –±–æ—Ç
    —É–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–º.
    """

    await message.answer("‚ùå –Ø —É–º–µ—é –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.")
